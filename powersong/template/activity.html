{% extends "base.html" %}
{% block content %}

<script>

  function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie != '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
              var cookie = jQuery.trim(cookies[i]);
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) == (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }


  function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
  }

  

  function sendPost(activity_id,key,value) {
    data = {}
    data[key] = value
    $.ajaxSetup({
      crossDomain: false, // obviates need for sameOrigin test
      beforeSend: function(xhr, settings) {
          if (!csrfSafeMethod(settings.type)) {
              xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
          }
      }
  });

    $.ajax({
        type: "POST",
        url: "/flag_activity/" + activity_id + '/',
        data: JSON.stringify(data),
        success: setTimeout(function(){ location.reload(); }, 1000)
    });
  }

</script>

{% if spotify_token %}
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>
    var player = undefined

    var spotify_ids = []
    var start_times = []
    {% for effort in top %}spotify_ids.push('spotify:track:{{ effort.song__spotify_id }}')
    start_times.push({{effort.start_time}})
    {% endfor %}

    var play = ({
          spotify_uri,
          position,
          playerInstance: {
            _options: {
              getOAuthToken,
              id
            }
          }
        }) => {
          getOAuthToken(access_token => {
            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${id}`, {
              method: 'PUT',
              body: JSON.stringify({ uris: spotify_uri, position_ms: position }),
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${access_token}`
              },
            });
          });
        };

    window.onSpotifyWebPlaybackSDKReady = () => {
      const token = '{{ spotify_token }}';
      player = new Spotify.Player({
        name: 'PowerSong web player',
        getOAuthToken: cb => { cb(token); }
      });


      // Error handling
      player.addListener('initialization_error', ({ message }) => { console.error(message); });
      player.addListener('authentication_error', ({ message }) => { console.error(message); });
      player.addListener('account_error', ({ message }) => { console.error(message); });
      player.addListener('playback_error', ({ message }) => { console.error(message); });

      // Playback status updates

      // Ready
      player.addListener('ready', ({ device_id }) => {
        console.log('Ready with Device ID', device_id);
      });

      // Not Ready
      player.addListener('not_ready', ({ device_id }) => {
        console.log('Device ID has gone offline', device_id);
      });

      // Connect to the player!
      player.connect();
      };

</script>  
{% endif %}


  <script>
    //var color_base = ['002b36', '073642', '586e75', '657b83', '839496', '93a1a1', 'eee8d5', 'fdf6e3'];
    var color_base = ['ff0000', '00ff00'];

    var color = Chart.helpers.color;
    var scatterChartData = {
        datasets: [
            {% if True %}
            {% decode_all qs=top as data_times %}
            {% for data_time in data_times %}
            {
            label: '',
            backgroundColor: color('#'+ color_base[{{ forloop.counter0 }} % color_base.length]).alpha(1).rgbString(),
            borderColor: color('#'+ color_base[{{ forloop.counter0 }} % color_base.length]).alpha(1).rgbString(),
            showLine: true,
            pointRadius: 3,
            fill: false,
            data: [
                {% for data,time,time_on_song in data_time %}{x: {{ time }}, y: {{ data }}}, {% endfor %}
            ]
            },
            {% endfor %}
            {% endif %}
        ]
    };

    window.onload = function() {
        var ctx = document.getElementById('canvas').getContext('2d');
        window.myScatter = Chart.Scatter(ctx, {
            data: scatterChartData,
            options: {
                title: {
                    display: true,
                    text: 'Speed over Time'
                }, legend: {
                    display: false 
                }, scales: {
                    yAxes: [{
                        label: 'Speed (m/s)',
                        display: true
                    }],
                    xAxes: [{
                        label: 'Time in Activity (s)',
                        display: true,
                        ticks: {
                            max: {{ activity.elapsed_time }}
                        }
                    }]
                },
                onClick: function(event, array) {
                    let element = this.getElementAtEvent(event);
                    if (element.length > 0) {
                        var value = this.data.datasets[element[0]._datasetIndex].data[element[0]._index];
                        
                        position = (value.x - start_times[element[0]._datasetIndex]) * 1000
                        play({
                          playerInstance: player,
                          spotify_uri: spotify_ids.slice(element[0]._datasetIndex),
                          position: (position)
                        });
                        
                    }
                }
            }
        });
    };
</script>


  <div class="container top-box-padding">
    <ul class="list-group">    
      <li class="list-group-item">
        <div class="container">
            <div class="row">
            	<div class="col-md-4">
            		<a class="h4 mylead-link" href="https://www.strava.com/activities/{{ activity.activity_id}}/">{{ activity.name}}</a>
            		<p class="h5">{{ activity.start_date_local }}</p>
                    {% if not demo %}
                    <p>
                        <a href="https://www.last.fm/user/{{ listener.nickname }}/library?from={{ activity.start_date_local|date:'Y-m-d' }}&rangetype=1day" class="btn btn-info btn-sm">
                            <span class="glyphicon glyphicon-repeat"></span> See on last.fm
                        </a>
                    </p>
                    <p>
                        <a href="/resync_last_fm/{{ activity.activity_id}}" class="btn btn-info btn-sm">
                            <span class="glyphicon glyphicon-repeat"></span> Resync last.fm
                        </a>
                        <a href="/resync_spotify/{{ activity.activity_id}}" class="btn btn-info btn-sm">
                            <span class="glyphicon glyphicon-repeat"></span> Resync Spotify
                        </a>
                    </p>
                    <p>
                        <button onclick="sendPost({{ activity.activity_id }},'flagged',!{{ activity.flagged|lower  }})" class="btn btn-alert btn-sm">
                            <span class="glyphicon glyphicon-repeat"></span>{% if activity.flagged %}Unflag{% else %}Flag{% endif %} activity
                        </button>
                        <button onclick="sendPost({{ activity.activity_id }},'flagged_hr',!{{ activity.flagged_hr|lower }})" class="btn btn-alert btn-sm">
                            <span class="glyphicon glyphicon-repeat"></span>{% if activity.flagged_hr %}Unflag{% else %}Flag{% endif %} activity efforts HR
                        </button>

                        
                    </p>
                    {% endif %}
            	</div>
                <div class="col-md-8">
                <div class="row">
                    <div class="col-6 col-md-4 text-right">
                		<span class="h4">{{ activity.avg_speed_pretty }} </span><span> {{ activity.avg_speed_pretty_units }} </span>
                        <p>speed</p>
                    </div>
                    <div class="col-6 col-md-4 text-right">
                        <span class="h4"> {{ activity.distance_pretty }} </span><span> {{ activity.distance_big_pretty_units }} </span>
                        <p>distance</p>
                    </div>
                    <div class="col-6 col-md-4 text-right">
                        <span class="h4"> {{ activity.moving_time_pretty }} </span>
                        <p>moving time</p>
                    </div>                    
            	</div>
                
                <div class="row">
                    <div class="col-6 col-md-4 text-right">
                    <span>{{ activity.elapsed_time_pretty }} </span>
                    <p>elap. time</p>
                    </div>
                    {% if activity.avg_hr %}
                    <div class="col-6 col-md-4 text-right">
                    <span>{{ activity.avg_hr }} </span><span> bpm</span>
                    <p>avg. HR</p>
                    </div>
                    {% endif %}
                    {% if activity.avg_watts %}
                    <div class="col-6 col-md-4 text-right">
                    <span>{{ activity.avg_watts }} </span><span> W</span>
                    <p>avg. power</p>
                    </div>
                    {% endif %}
                    {% if activity.avg_cadence %}
                    <div class="col-6 col-md-4 text-right">
                    <span>{{ activity.avg_cadence }} </span><span> spm</span>
                    <p>avg. cad</p>
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>
        <div class="row">
            <canvas id="canvas"></canvas>
        </div> 
      </div>
    </li>
    </ul>
   </div>

  	
    <div id='top'> {% include "top_table_activity.html" %} </div>

{% endblock %}
